---
capId: CAP-20251108-BMCA-001
gapId: GAP-BMCA-001
title: "BMCA Role & Comparator Integration Corrective Action Plan"
status: open
phase: 07-verification-validation
relatedRequirements:
  - REQ-F-002  # BMCA state machine
  - REQ-F-003  # Offset computation (dependent heuristic)
relatedDesign:
  - DES-C-003  # BMCA Component
  - DES-C-010  # Time Sync Component (dependency for role transitions)
relatedTests:
  - TEST-UNIT-BMCA-BASIC
  - TEST-UNIT-BMCA-EDGES
  - TEST-UNIT-BMCA-SELECTION
  - TEST-UNIT-BMCA-ROLE-ASSIGNMENT (planned RED)
standardReferences:
  - IEEE 1588-2019 Section 9.3  # Best master clock algorithm
  - IEEE 1588-2019 Section 8.2  # Data sets
  - IEEE 1012-2016 V&V (Corrective Action Loop)
created: 2025-11-08
owner: standards-engineering
---

## 1. Gap Statement

Current `PtpPort::run_bmca()` unconditionally drives a slave-oriented transition (`RS_SLAVE`) when any foreign master exists.

Missing pieces:

- Construction of local priority vector
- Full comparison ordering per IEEE 1588-2019 Section 9.3
- Differentiated role events (RS_MASTER / RS_GRAND_MASTER / RS_PASSIVE)
- Parent/Current data set updates from selected Announce
- Single authoritative `PriorityVector` definition (duplication in `clocks.hpp` vs `bmca.hpp`)

## 2. Impact Analysis

- Incorrect hierarchy: Potential master clocks demoted to slave
- Stagnant datasets: Grandmaster quality/identity fields remain defaults
- Partial test coverage: Ordering unit tests do not exercise integration path
- Distorted reliability heuristics: Offset sample progression tied to wrong role

## 3. Root Cause Hypothesis

Initial slice prioritized offset computation; BMCA integration deferred. Parallel scaffolding produced duplicate `PriorityVector` definitions without consolidation.

## 4. Interim Containment

- Preserve simplified BMCA (avoid speculative fixes) until RED test in place
- Document gap formally (this CAP) to block unrelated dataset enhancements

## 5. Corrective Action Plan (TDD)

### Red

1. Add `test_bmca_role_assignment.cpp` expecting master path when local priority is superior.
2. Assert state transition LISTENING → PRE_MASTER (via RS_MASTER event) fails with current stub.

### Green

1. Unify `PriorityVector` in `bmca.hpp`; remove port copy.
2. Build local vector from parent/grandmaster fields (placeholder quality values if self-root).
3. Translate foreign Announce list to `PriorityVector` array.
4. Invoke `selectBestIndex`; compare local vs foreign; emit RS_MASTER / RS_SLAVE / RS_PASSIVE accordingly.
5. Populate `ParentDataSet` when foreign selected; set `steps_removed`.
6. Maintain deterministic bounds (reuse fixed arrays, no heap).

### Refactor

1. Extract helper functions: `build_priority_vectors()` and `apply_bmca_decision()`.
2. Add metrics counters per decision path; health telemetry for last decision.
3. Remove legacy comparator in `clocks.hpp`.
4. Insert profile extension hook (comment only, YAGNI).

## 6. Acceptance Criteria

- RED test initially fails; passes after Green changes.
- Three scenarios verified: local best, foreign best, tie → passive.
- ParentDataSet updated within one tick after foreign Announce selection.
- Existing BMCA tests remain PASS (no regressions).
- Metrics counters increment (BMCA_Selections + decision path counters).
- Health telemetry records selection index and role classification.

## 7. Metrics

| Metric | Target |
|--------|--------|
| BMCA_Selections | ≥ 1 per run |
| DecisionPathCounters | Non-zero across scenario suite |
| ValidationsFailed (BMCA) | 0 normal path |
| RoleTransitionCount | Increments on each RS_* |

## 8. Traceability

|----------|-------|
| CAP-20251108-BMCA-001 | GAP-BMCA-001, REQ-F-002 |
| test_bmca_role_assignment.cpp | TEST-UNIT-BMCA-ROLE-ASSIGNMENT |
| bmca.cpp / clocks.cpp updates | REQ-F-002, DES-C-003 |

## 9. Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Role flapping | Add debounce timer (future enhancement) |
| Dataset update race with offset heuristic | Update datasets before offset calc in same tick |
| Structure duplication persists | Enforce single `PriorityVector` in Green phase |

## 10. Follow-Up (Out of Scope)

- Foreign master aging & pruning
- Profile-specific ordering adjustments
- Security flag evaluation (Annex P placeholder)

## 11. Compliance Notice

Conceptual references to IEEE 1588-2019 Sections 8.2 and 9.3 only; no reproduction of copyrighted text.
## 12. Status

- CAP created
- RED test pending creation
- Green implementation not started
| V&V Engineer | pending | pending | pending |
| Standards Lead | pending | pending | pending |

## 9. Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Role flapping due to rapid foreign master changes | Add debounce / holdover timer in later enhancement |
| Dataset update race with offset heuristic | Update datasets before offset calc in same tick |
| Memory overhead from duplicate structures | Unify `PriorityVector` early in Green phase |

- Foreign master aging/pruning (separate gap item).
- Profile-specific precedence adjustments (telecom profiles).
- Security flag evaluation (Annex P placeholder).

## 11. Copyright & Standards Compliance Notice

Implementation decisions reference IEEE 1588-2019 Section 9.3 and Section 8.2 conceptually without reproducing copyrighted text. All code and documentation herein are original; consult official IEEE standards for authoritative definitions.

## 12. Current Status

- CAP created (this document).
- RED test planned (pending file addition).
- Implementation not started.

## 13. Approval

| Role | Name | Date | Decision |
|------|------|------|----------|
| V&V Engineer | pending | pending | pending |
| Standards Lead | pending | pending | pending |

---
| Risk | Mitigation |
|------|------------|
| Role flapping due to rapid foreign master changes | Add debounce / holdover timer in later enhancement |
| Dataset update race with offset heuristic | Update datasets before offset calc in same tick |
| Memory overhead from duplicate structures | Unify `PriorityVector` early in Green phase |

## 10. Follow-Up Enhancements (Out of Scope Now)

- Foreign master aging/pruning (separate gap item).
- Profile-specific precedence adjustments (telecom profiles).
- Security flag evaluation (Annex P placeholder).

## 11. Copyright & Standards Compliance Notice

Implementation decisions reference IEEE 1588-2019 Section 9.3 and Section 8.2 conceptually without reproducing copyrighted text. All code and documentation herein are original; consult official IEEE standards for authoritative definitions.

## 12. Current Status

- CAP created (this document).
- RED test planned (pending file addition).
- Implementation not started.

## 13. Approval

| Role | Name | Date | Decision |
|------|------|------|----------|
| V&V Engineer | pending | pending | pending |
| Standards Lead | pending | pending | pending |

---
capId: CAP-20251108-BMCA-001
gapId: GAP-BMCA-001
title: "BMCA Role & Comparator Integration Corrective Action Plan"
status: open
relatedRequirements:
  - REQ-F-002  # BMCA state machine
  - REQ-F-003  # Offset computation (dependent heuristic)
relatedTests:
  - TEST-UNIT-BMCA-BASIC
  - TEST-UNIT-BMCA-EDGES
  - TEST-UNIT-BMCA-SELECTION
  - TEST-UNIT-BMCA-ROLE-ASSIGNMENT (planned RED)
standardReferences:
  - IEEE 1588-2019 Section 9.3  # Best master clock algorithm
  - IEEE 1588-2019 Section 8.2  # Data sets
created: 2025-11-08
owner: standards-engineering
---

## 1. Gap Statement
The current implementation `PtpPort::run_bmca()` uses a simplified placeholder: if any foreign master exists while in LISTENING it unconditionally triggers a slave-oriented transition (`RS_SLAVE`). It does not: (a) construct a local priority vector, (b) compare foreign masters using full IEEE 1588-2019 Section 9.3 ordering, (c) differentiate outcomes into RS_MASTER / RS_GRAND_MASTER / RS_PASSIVE events, or (d) update parent/current data sets based on the selected announce. Two separate `PriorityVector` structures exist (one in `clocks.hpp` and another in `bmca.hpp`), creating duplication and risk of inconsistency.

- Role misassignment: Nodes may become slaves when they should serve as master, degrading synchronization hierarchy.
## 1. Gap Statement
- Test coverage blind spot: Existing BMCA tests validate ordering logic inside `bmca.cpp` but not integration with port state transitions or dataset updates.
- Reliability metrics distortion: Incorrect role paths affect sequence of offset samples and heuristic transition from UNCALIBRATED → SLAVE.

## 2. Impact Analysis

- Role misassignment: Nodes may become slaves when they should serve as master, degrading synchronization hierarchy.
- Dataset stagnation: `ParentDataSet` and `CurrentDataSet` fields tied to Announce selection remain default values, impacting offset heuristics and traceability.
- Test coverage blind spot: Existing BMCA tests validate ordering logic inside `bmca.cpp` but not integration with port state transitions or dataset updates.
- Reliability metrics distortion: Incorrect role paths affect sequence of offset samples and heuristic transition from UNCALIBRATED → SLAVE.

## 3. Root Cause Hypothesis
### Red (Introduce failing tests)
1. Add `test_bmca_role_assignment.cpp` expecting: if local clock superiority holds vs. foreign announces, port transitions toward MASTER path (LISTENING → PRE_MASTER). Current behavior will FAIL (remains forcing SLAVE). 
2. Include assertions for selection telemetry (health metric `bmca_selection`).
## 4. Interim Containment Actions

- Keep simplified BMCA logic while introducing a RED integration test (`TEST-UNIT-BMCA-ROLE-ASSIGNMENT`) to prevent silent expansion of incorrect behavior.
- Document gap and traceability here; avoid downstream features (ParentDS update, pruning) until comparator integration is correct.
3. Translate each foreign Announce into a BMCA `PriorityVector` (mapping: priority1, clockClass, clockAccuracy, variance, priority2, stepsRemoved, grandmasterIdentity).
## 5. Corrective Action Plan (TDD Red → Green → Refactor)

### Red (Introduce failing tests)

1. Add `test_bmca_role_assignment.cpp` expecting: if local clock superiority holds vs. foreign announces, port transitions toward MASTER path (LISTENING → PRE_MASTER). Current behavior will FAIL (remains forcing SLAVE).
2. Include assertions for selection telemetry (health metric `bmca_selection`).
5. Update `ParentDataSet` and `CurrentDataSet.steps_removed` from chosen Announce when foreign master selected.
### Green (Minimal implementation to pass tests)

1. Unify `PriorityVector` definition: migrate to single structure in `bmca.hpp`; remove or adapt the one in `clocks.hpp` (retain only if port list needs a lightweight variant).
2. Construct local priority vector from `parent_data_set_` and static identity fields.
3. Translate each foreign Announce into a BMCA `PriorityVector` (mapping: priority1, clockClass, clockAccuracy, variance, priority2, stepsRemoved, grandmasterIdentity).
4. Use `BMCA::selectBestIndex` to choose best; compare selected foreign vs. local; emit appropriate `StateEvent`:
   - Local best & qualifies → RS_MASTER (LISTENING → PRE_MASTER)
   - Foreign best better → RS_SLAVE (LISTENING → UNCALIBRATED)
   - Foreign equal but topology worse → RS_PASSIVE
5. Update `ParentDataSet` and `CurrentDataSet.steps_removed` from chosen Announce when foreign master selected.
6. Preserve deterministic bounds (no dynamic allocation beyond existing max foreign array).
- Port transitions match IEEE 1588-2019 role selection logic for at least three crafted scenarios (local best, foreign best, tie → passive).
### Refactor (Quality & Extensibility)

1. Extract BMCA integration into dedicated helper inside `clocks.cpp` (e.g., `build_priority_vectors()` & `apply_bmca_decision()`).
2. Add metrics counters for decision paths (master, slave, passive) and tie scenarios.
3. Replace ad-hoc compare in `clocks.hpp` with call to BMCA comparator (remove duplicate implementation).
4. Prepare profile hooks (e.g., telecom vs. default profile) via strategy object (YAGNI for now, scaffolding comment only).
## 7. Metrics & Monitoring
## 6. Acceptance Criteria

- RED test `TEST-UNIT-BMCA-ROLE-ASSIGNMENT` initially fails; passes after Green implementation.
- Port transitions match IEEE 1588-2019 role selection logic for at least three crafted scenarios (local best, foreign best, tie → passive).
- ParentDataSet fields (grandmasterIdentity, grandmasterPriority1/2, clock quality, stepsRemoved) populated within one tick after Announce processing when foreign master chosen.
- No regression in existing BMCA ordering tests: `bmca_red_green_refactor_basic`, `bmca_edge_comparisons`, `bmca_selection_list` remain PASS.
- Metrics: BMCA_Selections increments; new counters for each decision path reflect exercised scenarios in test run.
- Health telemetry includes last BMCA selection index and role event classification.
| Artifact | Links |
## 7. Metrics & Monitoring

| Metric | Target | Notes |
|--------|--------|-------|
| BMCA_Selections | >= 1 per integration test | Confirms decision executed |
| BMCA_CandidateUpdates | > 0 when multiple foreign masters | Validates comparison loop |
| ValidationsFailed (BMCA path) | 0 in normal scenarios | Non-zero only for synthetic fault tests |
| RoleTransitionCount | Increments on each RS_* event | Derived from state_transitions |
- Risk: Dataset update race with offset heuristic → Mitigation: perform dataset assignment before offset calculations in same tick.
## 8. Traceability Matrix (Delta)

## 10. Follow-Up Enhancements (Out of Scope Now)
- Foreign master aging/pruning (separate gap item).
- Profile-specific precedence adjustments (telecom profiles).
- Security flag evaluation (Annex P placeholder).

## 11. Copyright & Standards Compliance Notice
Implementation decisions reference IEEE 1588-2019 Section 9.3 and Section 8.2 conceptually without reproducing copyrighted text. All code and documentation herein are original; consult official IEEE standards for authoritative definitions.

## 12. Current Status
- CAP created (this document).
- RED test planned (pending file addition).
- Implementation not started.

## 13. Approval
| Role | Name | Date | Decision |
|------|------|------|----------|
| V&V Engineer | pending | pending | pending |
| Standards Lead | pending | pending | pending |

---
Next Action: Add RED test file `test_bmca_role_assignment.cpp` then execute test to confirm failure prior to Green implementation.